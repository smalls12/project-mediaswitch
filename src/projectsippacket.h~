

#ifndef PROJECTSIPPACKET_H
#define PROJECTSIPPACKET_H

#include <string>

#include "projectwebdocument.h"


/*******************************************************************************
Class: sipuri
Purpose: Parse a SIP URI ref RFC 3261.
Examples:
  From: "A. G. Bell" <sip:agb@bell-telephone.com> ;tag=a48s
  From: sip:+12125551212@server.phone2net.com;tag=887s
  f: Anonymous <sip:c8oqz84zk7z@privacy.org>;tag=hyh8
Updated: 17.12.2018
*******************************************************************************/
class sipuri
{
public:
  inline sipuri( std::string &s )
  {
    /* Find display name */
    size_t dispstart = s.find( '"' );
    if( std::string::npos != dispstart )
    {
      size_t dispend = s.find( '"', dispstart + 1 );
      if( std::string::npos != dispstart )
      {
        this->displayname = substring( dispstart, dispend );
      }
    }

    size_t sipstart = s.find( "sip:" );
    if( std::string::npos == sipstart )
    {
      sipstart = s.find( "sips:" );
      if( std::string::npos == sipstart )
      {
        /* Nothing more we can do */
        return;
      }
    }

    /* We return to the display name where no quotes are used */
    if( 0 == this->displayname.end() )
    {
      if( sipstart > 0 )
      {
        const char *start = s.c_str();
        char *end = start + sipstart;
        char *ptr = start;
        int startpos = 0;
        int endpos = sipstart;
        for(  ; ptr < end; ptr++ )
        {
          if( ' ' != *ptr )
          {
            break;
          }
          startpos++;
        }

        for( ptr = end; ptr > startpos; ptr-- )
        {
          if( ' ' != *ptr )
          {
            break;
          }
          endpos--;
        }
        this->displayname = substring( startpos, endpos );
      }
    }
  }

  substring displayname;
};

/*******************************************************************************
Class: projectsippacket
Purpose: Unpacks data following the standard: https://www.ietf.org/rfc/rfc3261.txt.
Our purpose is to be effieicent (fast), we are not checking for perfect syntax
this object should still work even with inperfect SIP packets. Keep memory
allocation to a minimum. Work off just the main acket string and keep indexes
into that packet.
Updated: 12.12.2018
*******************************************************************************/
class projectsippacket : public projectwebdocument
{

public:
  projectsippacket( std::string packet );
  ~projectsippacket();


  /*
    Request-Line  =  Method SP Request-URI SP SIP-Version CRLF
    RESPONCE indicates it found a status code - so is a responce
    not a request.
  */
  enum { REGISTER, INVITE, ACK, CANCEL, BYE, OPTIONS, RESPONCE };

  enum { Authorization,
        Call_ID,
        Content_Length,
        CSeq,
        Contact,
        Content_Type,
        Expires,
        From,
        Max_Forwards,
        Proxy_Authenticate,
        Proxy_Authorization,
        Record_Route,
        Route,
        Retry_After,
        Supported,
        To,
        Via,
        User_Agent,
        WWW_Authenticate };

private:

  virtual void parsemethod( void );
  virtual int getheaderfromcrc( int crc );
  substring getheadervalue( substring header );

  substring headers[ WWW_Authenticate + 1 ];
  substring body;

};


#endif /* PROJECTSIPPACKET_H */

