# project mediaswitch

There are 3 components to this project

* project-control: Call control server
* project-sip: A SIP server
* project-rtp: An RTP server

Between the 3 sub projects, events re communicated via a HTTP event mechanism. i.e. if a new SIP call is generated by a client (which sends a SIP INVITE) then project-sip will pass a HTTP POST request back to the control server. Control server  will then communicate back instructions to both the SIP server and the RTP server.

The design of this project is designed to work with cloud services so that workloads can be scaled up and down appropriately.

Part of the design is to be in-memory. i.e. the SIP server should no be required to query a database to get username information. After starting, directory information should be pushed to the SIP server (either by the control server or your web site - a friendly host).

# Interfaces

All three projects are designed to either run on the same physical server or separate servers. This way load balancing between servers can be achieved. Multiple RTP servers can then be run to handle large volumes of transcoding for every SIP and control server.

All services communicate with each other via HTTP. The following section defines the interfaces. In this section all of the examples use curl to get or post data.

## project-control 

### POST http://control/invite

Similar to the sip server invite this call will originate a new call - but it will go through the call processing first (compared to the SIP interface which will blindly call the SIP endpoint).


### PUT http://control/reg

Notify the control server of a SIP registration. Generated by the SIP server and sent to the control server configured using the directory interface.

```
PUT http://127.0.0.1:9001/reg/bling.babblevoice.com/1003

{
  "host": "127.0.0.1",
  "port": 45646,
  "agent": "Z 5.2.28 rv2.8.114"
}
```

The host and port are the client network (where the request came from) and the agent is the agent string reported by the SIP client.

Example:
curl -X POST --data-raw '{ "domain": "bling.babblevoice.com", "user": "1000" }' -H "Content-Type:application/json" http://control/reg

### DELETE http://control/reg

Generated by the SIP server and sent to the control address against the domain configured using the directory interface. Notify the control server of a SIP de-registration.

```
DELETE http://127.0.0.1:9001/reg/bling.babblevoice.com/1003
```

Example using curl:
curl -X DELETE --data-raw '{ "domain": "bling.babblevoice.com", "user": "1000" }' -H "Content-Type:application/json" http://control/reg

## project-sip

### PUT http://sip/dir/domain

This interface is used to add directory information to the SIP server.

```
PUT http://127.0.0.1:9000/dir/bling.babblevoice.com

{
  "control": "http://127.0.0.1:9001", 
  "users": 
  [ 
    { 
      "username": "1003", 
      "secret": "1123654789"
    }
  ]
}
```

Returns 201 on success.

Example using curl:
```
curl -X PUT --data-raw '{ "control": "http://127.0.0.1:9001", "users": [ { "username": "1003", "secret": "1123654789"}]}' -H "Content-Type:application/json" http://127.0.0.1/dir/bling.babblevoice.com
```

* domain: the name of the sip domain
* control: a structure of host and port of the control server responsible for this domain
* users: an array of user structures containing username and secret

### PUT http://sip/dir/domain/username

This is synonymous with PATCH.

### PATCH http://sip/dir/domain/username

This will replace the user only. When PUT the domain, this replace the whole domain object.

```
PUT http://127.0.0.1:9000/dir/bling.babblevoice.com/1003

{
  "secret": "1123654789"
}
```

curl -X PUT --data-raw '{ "secret": "1123654789" }' -H "Content-Type:application/json" http://127.0.0.1/dir/bling.babblevoice.com/1003

### GET http://sip/dir/bling.babblevoice.com

Returns JSON listing this domains entry in the directory.

### DELETE http://sip/dir/bling.babblevoice.com

Remove the entry in the directory. The user can also be specified - /dir/bling.babblevoice.com/1003.

### GET http://sip/reg

Returns the number of registered clients.

The example:

```
GET http://127.0.0.1:9000/reg/bling.babblevoice.com
```

or to filter for a specific user

```
GET http://127.0.0.1:9000/reg/bling.babblevoice.com/1003
```

Returns 200 with the body:
```
{
  "domain": "bling.babblevoice.com",
  "count": 3,
  "registered": 1,
  "users": {
    "1000": {
      "registered": false
    },
    "1001": {
      "registered": false
    },
    "1003": {
      "registered": true,
      "outstandingping": 0,
      "remote": {
        "host": "127.0.0.1",
        "port": 42068,
        "agent": "Z 5.2.28 rv2.8.114"
      },
      "epochs": {
        "registered": 1552507958
      }
    }
  }
}
```

When a request is for a specific domain the fields are:

* count - number of users that exist for this domain
* registered - the number of users that are registered
* users - array listing the state of the each user, most of which are self explanatory, outstandingping is the current OPTIONS failure count.

```
GET http://127.0.0.1:9000/reg/
```
Returns 200 with the body:
```
{
  "count": 1255
}
```

This is a complete count of all registrations on this SIP server.


### POST http://sip/dialog/invite

Originate a new call.

curl -X POST --data-raw '[{ "domain": "bling.babblevoice.com", "to: "", "from": "", "maxforwards": 70, "callerid": { "number": "123", "name": "123", "private": false }, "control": { "host": "127.0.0.1", "port": 9001 } }]' -H "Content-Type:application/json" http://127.0.0.1/invite

The control option is optional. If it is in this is the server which will receive updates regarding the call flow. If not, the default one listed in the "to" field will be used. If not this, then no updates will be sent.

### POST http://sip/dialog/ring

Example:
curl -X  POST --data-raw '{ "callid": "<callid>", "alertinfo": "somealertinfo" }' -H "Content-Type:application/json" http://sip/dir

If the call is not in a ringing or answered state it will send a 180 ringing along with alert info if sent.


### GET http://sip/dialog

## project-rtp

### POST http://rtp/

Posting a blank document will create a new channel. 

Example:
curl -X  POST --data-raw '{}' -H "Content-Type:application/json" http://rtp/

The server will return a JSON document. Including stats regarding the workload of the server so that the control server can make decisions based on workload as well as routing.

# RFCs used in this project

* RFC 2616: Hypertext Transfer Protocol -- HTTP/1.1
* RFC 2617: HTTP Authentication: Basic and Digest Access Authentication
* RFC 3261: SIP: Session Initiation Protocol
* RFC 4566: SDP: Session Description Protocol
* RFC 3550: RTP: A Transport Protocol for Real-Time Applications
* RFC 3551: RTP Profile for Audio and Video Conferences with Minimal Control

# Testing

The SIP server can be run with the test flag:

project-sip --test

In the folder testfiles there are also other test files.

The default ports for the server are 9000 for the web server and 5060 for the SIP server.

## Memory

Some notes on using valgrind for memory testing.

### Running memory checking

valgrind --tool=massif project-rtp --fg

After running, this will create a massif file in the directry you run valgrind from. i.e. massif.out.3823
You can use ms_print to pretify th econtents of this file:

ms_print massif.out.3823

### Leak detection

valgrind --leak-check=yes project-rtp --fg

## Registry

registerclient.xml & .csv.

Which are config files to be used with sipp which can test various scenarios.

sipp 127.0.0.1:9997 -sf registerclient.xml -inf registerclient.csv -m 1 -l 1 -trace_msg -trace_err

or without the logging files.

sipp 127.0.0.1:9997 -sf registerclient.xml -inf registerclient.csv -m 1 -l 1

To upload test data to the sip server use

## Invite

sipp 127.0.0.1 -sf uaclateoffer.xml -m 1 -l 1

